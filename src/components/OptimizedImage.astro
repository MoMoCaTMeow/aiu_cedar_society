---
/**
 * OptimizedImage - MicroCMS画像最適化コンポーネント
 *
 * MicroCMSの画像APIを利用して、適切なサイズとフォーマットに最適化された
 * 画像を表示します。WebP変換、リサイズ、srcset対応を自動で行います。
 */
interface Props {
    src: string;
    alt: string;
    width: number;
    height?: number;
    sizes?: string;
    class?: string;
    loading?: "lazy" | "eager";
    fetchpriority?: "high" | "low" | "auto";
    quality?: number;
}

const {
    src,
    alt,
    width,
    height,
    sizes = "100vw",
    class: className = "",
    loading = "lazy",
    fetchpriority = "auto",
    quality = 80,
} = Astro.props;

/**
 * MicroCMS画像URLに最適化パラメータを追加
 * @param url - 元の画像URL
 * @param w - 幅（ピクセル）
 * @param q - 品質（1-100）
 * @returns 最適化パラメータ付きURL
 */
function getOptimizedUrl(url: string, w: number, q: number = quality): string {
    const separator = url.includes("?") ? "&" : "?";
    return `${url}${separator}w=${w}&fm=webp&q=${q}`;
}

// srcset生成（1x, 2x対応でRetinaディスプレイに最適化）
const srcset = [
    `${getOptimizedUrl(src, width)} 1x`,
    `${getOptimizedUrl(src, width * 2)} 2x`,
].join(", ");
---

<img
    src={getOptimizedUrl(src, width)}
    srcset={srcset}
    alt={alt}
    width={width}
    height={height}
    sizes={sizes}
    class={className}
    loading={loading}
    fetchpriority={fetchpriority}
    decoding="async"
/>
